
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NETCHB MANIFEST Transmit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background-image: url('https://i.pinimg.com/1200x/4b/d0/fb/4bd0fb4efdbbf4a03a4e32b72ad7819f.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      background-attachment: fixed;
      margin: 0;
      height: 100vh;
      font-family: Arial, sans-serif;
    }
    h2 {
      font-size: 50px;
      margin-top: 10px;
      text-align: center;
      color: purple;
    }
    .button-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-top: 40px;
    }
    button {
      background-color: #9900ff;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      min-width: 180px;
      font-weight: bold;
      font-size: 15px;
    }
    #fileInfo {
      font-weight: bold;
      text-align: center;
    }
    #fileName {
      font-weight: bold;
      color: black;
    }
    #removeBtn {
      cursor: pointer;
      color: red;
      margin-left: 6px;
    }
  </style>
</head>
<body>
  <h2>NETCHB MANIFEST Transmit</h2>
  <div class="button-wrapper">
    <button onclick="document.getElementById('inputFile').click()">Choose File</button>
    <input type="file" id="inputFile" onchange="handleFileSelected()" style="display: none;" />
    <div id="fileInfo">
      <span id="fileName"></span>
      <span id="removeBtn" onclick="removeFile()" style="display: none;">‚ùå</span>
    </div>
    <button onclick="handleProcess()">Proceed</button>
  </div>
  <script>
    const templateURL = "https://jun2369.github.io/MAWBchangenew/NETCHB%20template001.xlsx";
    const FIXED_COLUMNS = ['B', 'D', 'E', 'F', 'J', 'M', 'V', 'W', 'X', 'Z', 'AA', 'AL', 'AR', 'AU', 'AV', 'AW', 'AX'];
    const MAPPING_COLUMNS = {'E': 'H','K': 'O','L': 'P','M': 'Q','N': 'S','O': 'T','F': 'AM'};
    const CITY_CODE_MAP = {'HONG KONG': 'HK','SICHUAN': 'SC','BEIJING': 'BJ','SHANGHAI': 'SH','GUANGZHOU': 'GZ','SHENZHEN': 'SZ','CHENGDU': 'CD','TIANJIN': 'TJ','WUHAN': 'WH','XIAMEN': 'XM','NINGBO': 'NB'};
    let userWorkbook = null;
    function handleFileSelected() {
      const input = document.getElementById('inputFile');
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          userWorkbook = XLSX.read(data, { type: 'array' });
          document.getElementById('fileName').innerText = file.name;
          document.getElementById('removeBtn').style.display = 'inline';
        };
        reader.readAsArrayBuffer(file);
      }
    }
    function removeFile() {
      userWorkbook = null;
      document.getElementById('inputFile').value = "";
      document.getElementById('fileName').innerText = "";
      document.getElementById('removeBtn').style.display = "none";
    }
    async function handleProcess() {
      if (!userWorkbook) {
        alert("Please upload a file first.");
        return;
      }
      const templateWorkbook = await fetchAndReadXLSX(templateURL);
      const outputWorkbook = XLSX.utils.book_new();
      const userSheet = userWorkbook.Sheets[userWorkbook.SheetNames[0]];
      const templateSheet = templateWorkbook.Sheets[templateWorkbook.SheetNames[0]];
      const newSheet = {};
      const totalCols = 128;
      const totalColLetters = Array.from({ length: totalCols }, (_, i) => XLSX.utils.encode_col(i));
      const startRow = 11;
      const endRow = findLastDataRow(userSheet, 'A', startRow);
      const dataRowCount = endRow - startRow + 1;
      const totalRows = dataRowCount + 1;
      for (let colLetter of totalColLetters) {
        const isFixed = FIXED_COLUMNS.includes(colLetter);
        const targetFromUpload = Object.entries(MAPPING_COLUMNS).find(([, tgt]) => tgt === colLetter);
        for (let r = 2; r <= totalRows; r++) {
          const srcRow = startRow + r - 2;
          if (r === 2) {
            const headerCell = templateSheet[`${colLetter}1`];
            if (headerCell) newSheet[`${colLetter}1`] = { ...headerCell };
          }
          if (isFixed) {
            const baseCell = templateSheet[`${colLetter}2`] || { t: 's', v: '' };
            newSheet[`${colLetter}${r}`] = { ...baseCell };
          } else if (targetFromUpload) {
            const srcColLetter = targetFromUpload[0];
            const valueCell = userSheet[`${srcColLetter}${srcRow}`];
            newSheet[`${colLetter}${r}`] = valueCell ? { ...valueCell } : { t: 's', v: '' };
          } else {
            newSheet[`${colLetter}${r}`] = { t: 's', v: '' };
          }
        }
      }
      for (let r = 2; r <= totalRows; r++) {
        const srcRow = startRow + r - 2;
        newSheet[`AC${r}`] = { t: 's', v: userSheet[`H${srcRow}`]?.v || '' };
        newSheet[`AK${r}`] = { t: 's', v: userSheet[`H${srcRow}`]?.v || '' };
        newSheet[`N${r}`] = { t: 's', v: userSheet[`Q${srcRow}`]?.v || '' };
        newSheet[`BF${r}`] = { t: 's', v: userSheet[`R${srcRow}`]?.v || '' };
        newSheet[`I${r}`] = { t: 's', v: userSheet[`J${srcRow}`]?.v || '' };
        newSheet[`AO${r}`] = { t: 's', v: userSheet[`G${srcRow}`]?.v || '' };
      }
      const rawH9 = userSheet['H9']?.v ? new Date(userSheet['H9'].v) : null;
      const formattedDate = rawH9 ? rawH9.toISOString().slice(0, 10) : '';
      for (let r = 2; r <= totalRows; r++) {
        newSheet[`K${r}`] = { t: 's', v: formattedDate };
        newSheet[`L${r}`] = { t: 's', v: formattedDate };
      }
      const cellU9 = userSheet['U9']?.v ? String(userSheet['U9'].v) : '';
      const cellL9 = userSheet['L9']?.v ? String(userSheet['L9'].v) : '';
      const cellF9 = userSheet['F9']?.v ? String(userSheet['F9'].v) : '';
      for (let r = 2; r <= totalRows; r++) {
        newSheet[`AH${r}`] = { t: 's', v: cellU9.slice(0, 3) };
        newSheet[`AI${r}`] = { t: 's', v: cellU9.slice(-8) };
        newSheet[`AB${r}`] = { t: 's', v: cellL9 };
        newSheet[`AS${r}`] = { t: 's', v: cellF9.slice(0, 2) };
        newSheet[`AT${r}`] = { t: 's', v: cellF9.slice(2) };
      }
      const rawCity = userSheet['B9']?.v ? String(userSheet['B9'].v).toUpperCase().trim() : '';
      const cityCode = CITY_CODE_MAP[rawCity] || '';
      for (let r = 2; r <= totalRows; r++) {
        newSheet[`AP${r}`] = { t: 's', v: cityCode };
      }
      const groupSize = 998;
      for (let r = 2; r <= totalRows; r++) {
        const groupNumber = Math.ceil((r - 1) / groupSize);
        newSheet[`C${r}`] = { t: 's', v: String(groupNumber) };
      }
      newSheet["!ref"] = `A1:DX${totalRows}`;
      XLSX.utils.book_append_sheet(outputWorkbook, newSheet, "Result");
      XLSX.writeFile(outputWorkbook, "NETCHB_Export.xlsx");
      removeFile();
    }
    async function fetchAndReadXLSX(url) {
      const response = await fetch(url);
      const buffer = await response.arrayBuffer();
      return XLSX.read(buffer, { type: 'array' });
    }
    function findLastDataRow(sheet, colLetter, startRow) {
      let row = startRow;
      while (sheet[`${colLetter}${row}`] && sheet[`${colLetter}${row}`].v) row++;
      return row - 1;
    }
  </script>
</body>
</html>
